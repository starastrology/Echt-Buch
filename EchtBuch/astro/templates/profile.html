{% load stuff %}
{% load static %}
<html>
		<head>
	
			<meta name="viewport" content="width=device-width, initial-scale=1">
			<link rel="apple-touch-icon" sizes="180x180" href="{% static "eb.png" %}">
						<link rel="icon" type="image/png" sizes="32x32" href="{% static "favicon.ico" %}">
						<link rel="icon" type="image/png" sizes="16x16" href="{% static "favicon.ico" %}">
						<link rel="mask-icon" href="{% static "favicon.ico" %}" color="#5bbad5">
						<meta name="msapplication-TileColor" content="#da532c">
						<meta name="theme-color" content="#ffffff">
							
								<title>Echt Buch - {{ user.user.username }}</title>
										<link href="{% static 'bootstrap-5.1.3-dist/css/bootstrap.css' %}" rel="stylesheet"></style>
												<script src="{% static 'jquery-3.6.0.min.js' %}"></script>
														<script src="{% static 'bootstrap-5.1.3-dist/js/bootstrap.js' %}"></script>
															<script>
																	function getLocation() {
																		  if (navigator.geolocation) {
																			      navigator.geolocation.getCurrentPosition(showPosition);
																			    } else {
																				        alert("Geolocation is not supported by this browser.");
																				      }
																	}

function showPosition(position) {
	  var lat=position.coords.latitude; 
	  var lng=position.coords.longitude;
	  $.ajax({
		  	url: "{% url 'set_last_seen' %}",
		  	data: {"lat": lat, "lng": lng},
		   	type: "GET",	
		  	success: function(data){
						$('#last_seen').html(data);
					}
		    }); 
}

	$(document).ready(function(){
				$('#flexSwitchCheckChecked').click(function(){
								$('#pic_form').toggle();
							});
				$('#check_in').click(function(){
								getLocation();
							});
				$('#friend_request').click(function(){
								$.ajax({
													url: "{% url 'friend_request' %}",
													data: {"to": {{user.id}}},
									 				type: "POST",	
													success: function(data){
																			$('#friend_request').html('pending friend request...');
																			$('#friend_request').prop('disabled', true);
																		}
									  			});			
							});
			});
	</script>
		</head>
			<body>
						{% include 'header.html' %}
								<div class="container">
											{% if messages %}
													<div class="alert alert-success">
														        	{% for message in messages %}
																           		{{ message }}
																					{% endfor %}
																					    		</div>	
																								    	{% endif %}
																												
																										<div class="row">

																											<div class="col-sm-4">
																														{% if user.profile_pic %}<img style="width: 100%;" src="{{ user.profile_pic.url }}" />
																															{% else %}
																																<img src="{% static 'blank-avatar.webp' %}" style="width: 100%;" /> 
																																{% endif %}
																																{% if request.user.is_authenticated and user.user == request.user %}
																																       <div class="form-check form-switch">
																																	         		<input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked">
																																				  		<label class="form-check-label" for="flexSwitchCheckChecked">Change Profile Picture</label>
																																       </div>
																																       		<form style="display:none;" id="pic_form" enctype="multipart/form-data" action="{% url 'upload_profile_pic' %}" method="POST">
																																						{% csrf_token %}	
																																									<label for="img" class="form-label">Select image:</label>
																																									  			<input class="form-control btn btn-warning" type="file" id="img" name="img" accept="image/*">
																																												  			<button class="btn btn-info">Upload</button>
																																																		<input type=hidden name="id" value="{{user.id}}" />
																																																				</form>
																																																					
																																																					<div class="card">
																																																						  			<div class="card-body">
																																																														<h5>Friend Requests</h5>
																																																															{% if friend_requests %}
																																																															    		{% for friend_request in friend_requests %}
																																																																				<div class="row">
																																																																									<div class="col-sm-3">
																																																																															<a href="{% url 'profile' friend_request.ind1.id %}"><img src="{% if friend_request.ind1.profile_pic %}{{ friend_request.ind1.profile_pic.url }}{% else %}{% static 'blank-avatar.webp' %}{% endif %}" style="margin-top: 50%; height: 75px;" /></a>
																																																																																			</div>
																																																																																							<div class="col-sm-9">
																																																																																												<form action="{% url 'accept_friend_request' %}" method="GET">
																																																																																																		<input type=hidden name="id" value="{{friend_request.ind1.id}}" />
																																																																																																							<button id="accept_friend_request" class="btn btn-success">Accept Friend Request from {{friend_request.ind1.user.username}}</button>
																																																																																																											</form>
																																																																																																															<form action="{% url 'deny_friend_request' %}" method="GET">
																																																																																																																					<input type=hidden name="id" value="{{friend_request.ind1.id}}" />
																																																																																																																										<button id="deny_friend_request" class="btn btn-danger">Deny Friend Request from {{friend_request.ind1.user.username}}</button>
																																																																																																																														</form>
																																																																																																																																		</div>
																																																																																																																																					</div>
																																																																																																																																							{% endfor %}
																																																																																																																																								{% else %}
																																																																																																																																										No friend requests right now.
																																																																																																																																											{% endif %}
																																																									</div>
																																																					</div>
																																																					{% elif request.user.is_authenticated %}
																																																						{% if not friendship or friendship.pending %}
																																																								<div class="card"><div class="card-body"><button class="btn btn-primary" id="friend_request" {% if friendship.pending %}disabled{% endif %}>{% if friendship.pending %}friend request pending...{% else %}Friend Request {{user.user.username}}{%endif%}</button>
																																																									</div></div>
																																																										{% endif %}
																																																										{% endif %}
																																																										<div class="card"><div class="card-body">
																																																												<h2>{{ user.first_name }} {{ user.last_name }}</h2> 
																																																													<div class="progress">
																																																														  <div class="progress-bar" role="progressbar" style="width: {{user.compatibility}}%" aria-valuenow="{{user.compatibility}}" aria-valuemin="0" aria-valuemax="100">{% if request.user.is_authenticated %}{{user.compatibility}}% compatible{% else %}Login to find out how compatible you are with {{user.user.username}}{% endif %}</div>
																																																													</div>

																																																														<h3>{{ user.gender }} {% if friendship and not friendship.pending %} - You're friends{% endif %}</h3>
																																																															<h6>
																																																																				{{ user.dob }} in {{ user.place_of_birth.name }}
																																																																					</h6>	
																																																																								<table class="table table-striped table-hover">
																																																																														<tr>
																																																																																					<th>Body</th>
																																																																																											<th>Zodiac Sign</th>
																																																																																																	<th>Symbol</th>
																																																																																																						</tr>
																																																																																																											<tr>
																																																																																																																		<td>Sun</td>
																																																																																																																								<td>{{user.sun_sign.sign}}</td>
																																																																																																																														<td>{{ user.sun_sign.html_code|safe }}</td>
																																																																																																																																			</tr>
																																																																																																																																								<tr>
																																																																																																																																															<td>Moon</td>
																																																																																																																																																					<td>{{user.moon_sign.sign}}</td>
																																																																																																																																																											<td>{{ user.moon_sign.html_code|safe }}</td>
																																																																																																																																																																</tr>
																																																																																																																																																																					<tr>
																																																																																																																																																																												<td>Ascendant</td>
																																																																																																																																																																																		<td>{{user.rising_sign.sign}}</td>
																																																																																																																																																																																								<td>{{ user.rising_sign.html_code|safe }}</td>
																																																																																																																																																																																													</tr>
																																																																																																																																																																																																		<tr>
																																																																																																																																																																																																									<td>Mercury</td>
																																																																																																																																																																																																															<td>{{user.mercury_sign.sign}}</td>
																																																																																																																																																																																																																					<td>{{ user.mercury_sign.html_code|safe }}</td>
																																																																																																																																																																																																																										</tr>
																																																																																																																																																																																																																															<tr>
																																																																																																																																																																																																																																						<td>Venus</td>
																																																																																																																																																																																																																																												<td>{{user.venus_sign.sign}}</td>
																																																																																																																																																																																																																																																		<td>{{ user.venus_sign.html_code|safe }}</td>
																																																																																																																																																																																																																																																							</tr>
																																																																																																																																																																																																																																																												<tr>
																																																																																																																																																																																																																																																																			<td>Mars</td>
																																																																																																																																																																																																																																																																									<td>{{user.mars_sign.sign}}</td>
																																																																																																																																																																																																																																																																															<td>{{ user.mars_sign.html_code|safe }}</td>
																																																																																																																																																																																																																																																																																				</tr>
																																																																																																																																																																																																																																																																																									<tr>
																																																																																																																																																																																																																																																																																																<td>Jupiter</td>
																																																																																																																																																																																																																																																																																																						<td>{{user.jupiter_sign.sign}}</td>
																																																																																																																																																																																																																																																																																																												<td>{{ user.jupiter_sign.html_code|safe }}</td>
																																																																																																																																																																																																																																																																																																																	</tr>
																																																																																																																																																																																																																																																																																																																					</table>

																																																											</div></div>
																																																											<div class="card">
																																																												  <div class="card-body">

																																																													  <h5>Friends</h5>
																																																													  <ul>
																																																														  {% for friend in friends %}
																																																														  	{% if friend.ind1 != user %}
																																																																	<li><a href="{% url 'profile' friend.ind1.id %}"><img src="{% if friend.ind1.profile_pic %}{{ friend.ind1.profile_pic.url }}{%else%}{% static 'blank-avatar.webp' %}{%endif%}" style="width:100px;" /></a> {{ friend.ind1.first_name }} {{ friend.ind1.last_name }}</li>
																																																																		{% else %}
																																																																				<li><a href="{% url 'profile' friend.ind2.id %}"><img src="{% if friend.ind2.profile_pic %}{{ friend.ind2.profile_pic.url }}{%else%}{% static 'blank-avatar.webp' %}{%endif%}" style="width: 100px;" /></a> {{ friend.ind2.first_name }} {{ friend.ind2.last_name }}</li>
																																																																					{% endif %}
																																																																					{% endfor %}
																																																												  </div>
																																																											</div>
																																																											{% if friendship and not friendship.pending %}
																																																											<div class="card">
																																																												  <div class="card-body">
																																																													  	<form action="{% url 'unfriend' %}" method="GET">
																																																																	<button class="btn btn-danger" onclick="return confirm('Are you sure you want to unfriend {{user.user.username}}?');">Unfriend {{user.user.username}}</button>
																																																																			<input type=hidden name=id value="{{user.id}}" />
																																																																			 	</form>
																																																												  </div>
																																																											</div>
																																																											{% endif %}
																											</div>
																											<div class="col-sm-8">
																													
																													{% if user.last_seen or request.user.is_authenticated and user.user == request.user %}		
																														<div class="card">
																															  <div class="card-body">
																																  	<span id="last_seen">
																																			{% if user.last_seen %}
																																			  	Last seen in {{ user.last_seen.name }}.
																																					{% endif %}
																																						</span>
																																							{% if request.user.is_authenticated and user.user == request.user %}
																																								<button id="check_in" class="btn btn-success">Check In</button>
																																									{% endif %}
																																										</div>
																														</div>	
																														{% endif %}
																															{% if friendship and not friendship.pending or user.user == request.user %}
																																<div class="card">
																																			<div class="card-body">
																																							<form action="{% url 'post_on_wall' %}" method="POST">
																																												{% csrf_token %}
																																																<input type=hidden name="to_ind" value="{{user.id}}" />
																																																				<div class="mb-3">
																																																									<textarea required class="form-control" name="text" placeholder="Post on {{ user.user.username }}'s wall"></textarea>
																																																				</div>
																																																								<div class="mb-3">
																																																													<button class="btn btn-primary">Post</button>
																																																																	</div>
																																																																				</form>
																																																																						</div>
																																																																							</div>
																																																																								{% endif %}

																																																																									<h5>{{ user.user.username }}'s Wall</h5>
																																																																										<div class="card">
																																																																													
																																																																													{% for post in posts %}
	
	<div class="card-body">
		<div>
<b id="comment_{{post.id}}"></b>
		</div>
		<a href="{% url 'profile' post.from_ind.id %}"><img src="{% if post.from_ind.profile_pic %}{{ post.from_ind.profile_pic.url }}{% else %}{% static 'blank-avatar.webp' %}{%endif %}" style="width: 100px;" /></a> <blockquote> {{ post.text }} </blockquote>
	<script>
		var d = new Date({{post.date_time.year}}, {{post.date_time.month|add:-1}} , {{post.date_time.day }}, {{ post.date_time.hour }}, {{ post.date_time.minute }}, 0);
		var tzDifference = d.getTimezoneOffset();
		var offsetTime = new Date(d.getTime() + 2 * tzDifference * 60 * 1000);
		var html = offsetTime.getMonth() + "/" + offsetTime.getDate() + "/" + offsetTime.getFullYear() + " " + offsetTime.getHours() + ":" + String(offsetTime.getMinutes()).padStart(2, "0");
		document.getElementById('comment_'+{{post.id}}).innerHTML = html;
	</script>																																																																																						
																																																																																						</div>
																																																																																								{% endfor %}
																																																																																										{% if not posts %}
																																																																																													<div class="card-body">
																																																																																																		No posts yet on {{ user.user.username }}'s wall.
																																																																																																					</div>
																																																																																																							{% endif %}
																																																																																																								</div>
																																																																																																									</div>
																										</div>
								</div>
								{% include 'footer.html' %}
									</body>
</html>
